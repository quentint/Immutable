<!DOCTYPE html>
<html>
<head>
    <title>innmind/immutable</title>
    <link rel="stylesheet" href="https://innmind.github.io/Immutable/static/main.css"/>
    <link rel="stylesheet" href="https://innmind.github.io/Immutable/static/styles/default.css"/>
    <link rel="stylesheet" href="https://innmind.github.io/Immutable/static/styles/atom-one-dark.css"/>
    <script src="https://innmind.github.io/Immutable/static/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
    <header>
        <a href="https://innmind.github.io/Immutable/"><code>immutable</code></a>
    </header>
    <aside>
        <ul>
                    <li>
                                    <a href="https://innmind.github.io/Immutable/index.html">
                        Getting started
                    </a>
                            </li>
                    <li>
                                    <details open>
                        <summary>
                                                            Structures
                                                    </summary>
                        <ul>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/SEQUENCE.html">
                                        Sequence
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/SET.html">
                                        Set
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/MAP.html">
                                        Map
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/STR.html">
                                        Str
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/REGEXP.html">
                                        RegExp
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/MAYBE.html">
                                        Maybe
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/EITHER.html">
                                        Either
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/STATE.html">
                                        State
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/MONOIDS.html">
                                        Monoids
                                    </a>
                                </li>
                                                    </ul>
                    </details>
                            </li>
                    <li>
                                    <details open>
                        <summary>
                                                            Use cases
                                                    </summary>
                        <ul>
                                                            <li class="sub-item current">
                                    <a href="https://innmind.github.io/Immutable/LAZY_FILE.html">
                                        How to read a file
                                    </a>
                                </li>
                                                            <li class="sub-item ">
                                    <a href="https://innmind.github.io/Immutable/PARSING.html">
                                        Parsing strings
                                    </a>
                                </li>
                                                    </ul>
                    </details>
                            </li>
                    <li>
                                    <a href="https://innmind.github.io/Immutable/BLACKBOX.html">
                        Blackbox
                    </a>
                            </li>
                    <li>
                                    <a href="https://innmind.github.io/Immutable/PHILOSOPHY.html">
                        Philosophy
                    </a>
                            </li>
                </ul>
    </aside>
    <main><h1 id="how-to-read-a-file"><a href="#how-to-read-a-file" class="anchor">#</a>How to read a file</h1>
<p>This example below will show you how to build complex pipelines to read files without ever loading the whole file in memory, allowing you to read any file's size.</p>
<p>This example below looks for a user in a csv file with a score above <code>100</code>.</p>
<pre><code class="language-php">use Innmind\Immutable\{
    Sequence,
    Str,
};

$lines = Sequence::lazy(function(callable $registerCleanup) {
    $handle = \fopen('users.csv', 'r');
    $registerCleanup(fn() => \fclose($handle));

    while (!\feof($handle)) {
        yield (string) \fgets($handle);
    }

    \fclose($handle);
});
/** @var Maybe<User> */
$user = $lines
    ->map(fn(string $line) => Str::of($line))
    ->map(fn(Str $line) => $line->trim())
    ->filter(fn(Str $line) => !$line->empty())
    ->filter(fn(Str $line) => $line->contains(','))
    ->map(fn(Str $line) => $line->split(','))
    ->map(fn(Sequence $columns) => User::of($columns)) // ficticious class
    ->find(fn(User $user) => $user->score() > 100);</code></pre>
<p>The final <code>$user</code> variable is an instance of <code>Maybe</code> because the user may or may not exist.</p>
<p>If a user is found before the end of the file the sequence will stop reading the file and call the function passed to <code>$registerCleanup</code> allowing you to close the file handle properly.</p>
<p>Since this is a lazy sequence the file is iterated over only when trying to extract a concrete value, in this case via <code>->find()</code>. This means that even though the pipeline contains multiple steps the file is read only once. This decoupling between reading the file and building a pipeline to compute a value allows you to split the construction of the pipeline across multiple layers in your application without worrying about performance.</p>
<p>The other advantage of this technique is that it allows to read files that may not fit in memory.</p>
<h2 id="merging-multiple-files-in-a-single-pipeline"><a href="#merging-multiple-files-in-a-single-pipeline" class="anchor">#</a>Merging multiple files in a single pipeline</h2>
<p>The lazyness described above still works when you combine multiple lazy sequences.</p>
<pre><code class="language-php">$openFile = fn(string $name) => function(callable $registerCleanup) use ($name) {
    $handle = \fopen($name, 'r');
    $registerCleanup(fn() => \fclose($handle));

    while (!\feof($handle)) {
        yield (string) \fgets($handle);
    }

    \fclose($handle);
};

$users = Sequence::lazy($openFile('users1.csv'))
    ->append(Sequence::lazy($openFile('users2.csv')))
    ->append(Sequence::lazy($openFile('users3.csv')));

/** @var callable(Sequence<string>): Maybe<User> $findUser */
$findUser = function(Sequence $users): Maybe {
    // todo build a pipeline to find a user
};

$user = $findUser($users);</code></pre>
<p>Here we create a sequence that will sequentially read the 3 files <code>users1.csv</code>, <code>users2.csv</code> and <code>users3.csv</code> but the <code>$findUser</code> function is not aware of where the data comes from. This composition will open <code>users2.csv</code> only if the user is not found in <code>users1.csv</code>.</p>
<p>In this example the 3 sources are all files but you could mix the sources with different generators, for example you could combine from a file with another one coming from a database.</p></main>
    <footer>
        <a href="https://github.com/innmind/Immutable/" target="_blank">GitHub</a>
    </footer>
</body>
</html>